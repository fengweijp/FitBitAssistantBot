<a name="#Top"></a>[toc]
<h1>Introduction</h1>
<p>Any business which transacts online requires providing some kind of chat support for the issues related to their business. This can be done by developing chat applications where the consumers directly chat with the agent of the business who then solve their problems. A new alternative to answering frequently asked questions is the use of the Chat Bot which is intelligent enough to understand the questions raised by the user and determine the solutions to them on the real-time basis. Or in case of an administrator, if they are managing a lot of operative tasks or a lot of source code bases, then an intelligent bot is of great help. In case of personal assistants, the chat bots can be used to set up reminders, book appointments, tickets, or to get reports for the user.
</p>
<h1>Scenario</h1>
<p>In this article we will see how to develop a personal assistant chat bot which is integrated with the FitBit&nbsp; and can query and modify the Fitness data stored by FitBit. FitBit is a company which manufactures the Fitness Tracker bands which are used by people around the globe to track their daily fitness level&nbsp; We will see how to set up the authentication to the FitBit web API and integrate it with the chat bot to get a seamless performance. We will use the Microsoft Bot Framework v 4.0.8 which works with ASP.NET core 2.0 and higher. This framework makes development really fun and interesting as it provides multiple out of the box ways to develop the chat bot.
</p>
<h1>Tools and Frameworks Used</h1>
<p>We will need following tools and frameworks installed on the development machine
</p>
<ul>
    <li>Visual Studio 2017 (Community Edition:&nbsp;<a href="https://visualstudio.microsoft.com/downloads/" target="_blank" rel="noopener">Download Visual Studio 2017</a> )</li>
    <li>ASP.NET core 2.0 or higher (Download Link: <a href="https://www.microsoft.com/net/download" target="_blank" rel="noopener">.Net Core Download</a>)</li>
    <li>Bot Emulator (Download Link: <a href="https://github.com/Microsoft/BotFramework-Emulator/releases" target="_blank" rel="noopener">Bot Emulator Download Link</a>)</li>
    <li>Nuget Package Manager (Download Link: <a href="https://nodejs.org/en/download/">Install Node JS</a>)</li>
</ul>
<h1>Basic Concepts</h1>
<p>In case of bots, as stated earlier the conversation is the medium through which the user interacts with the application(the bot). So in case of the bot what ever happens we call that an activity, so an action basically is an activity. When the user replies
or asks a question, they are sending a message to the bot hence it becomes an activity and it is called message activity. This is the basic activity around which most of the logic is written. There are the other handful of activities which monitor when another
party joins the conversation, leaves it or if there is any update to the conversation.
When bot gets a message and replies to it, that constitutes a complete cycle when the conversations is initiated either way. This is called a Turn. Now a bot can collect information from user in various way
</p>
<ol>
    <li>Asking user questions</li>
    <li>Giving a form to user to fill out.</li>
    <li>Sending out visual cards to make the user select the options</li>
</ol>
The first is achieved using a dialog and the later is done using form flow and rich cards. Here we will implement the conversation using the rich cards which are sent as attachments by the bot.
<h2>What are Rich Cards?</h2>
Whenever a message is exchanged between user and the bot, it is done as Activity. The activity object has Attachments property which can be use to send out the rich cards. These rich cards are rendered as a list or carousel to the user based upon the type of the rich card used.
Following are different cards that are available to us to be used in our bots.
<ul>
    <li>Adaptive Cards&nbsp;: These are customizable cards which can contain images, text, buttons and speech.</li>
    <li>Animation Card : Cards that can play GIFs and short videos</li>
    <li>Audio Card: Cards which can play the audio</li>
    <li>Hero Card: A card that contains a single large image and buttons and text.</li>
    <li>Thumbnail Card:&nbsp; A card which contains a single thumbnail and buttons and text</li>
    <li>Receipt Card: Card which can be used to provide receipt to the user</li>
    <li>SignIn Card: Card which sends the user the card to sign in. The click action can be customized to redirect user to a new sign in page</li>
    <li>Video Card: A card that plays video.</li>
</ul>
Based upon our requirement we can use any of these cards to make the user experience more beautiful. More can be read about the rich cards at&nbsp;<a href="https://docs.microsoft.com/en-us/azure/bot-service/dotnet/bot-builder-dotnet-add-rich-card-attachments?view=azure-bot-service-3.0" target="_blank" rel="noopener">Rich Cards</a>
<h2>Authentication in Bot</h2>
In our scenario we are going to consume the FitBit web API to get the fitness data for the user from the FitBit servers. FitBit web api implements OAuth 2.0 security protocol. In order to use the FitBit api we need to create an application on the FitBit portal (discussed in detail in implementation section) and then implement the Implicit Grant flow(Refer See Also section). In Bot Framework SDKs earlier than v4, the developers had to implement the OAuth&nbsp;Controllers, Login Links and also had to make up arrangement to store the client ids, secrets and also the management of token. But starting v4, it has become very easy to implement the OAuth authentication in the bot.&nbsp; Following are the steps that we have to implement to get the OAuth working.
<ul>
    <li>We need to create a OAuth Setting on our Bot Channels Registration and add the details like Client Secret, Application Id and Scopes in this setting.</li>
    <li>Add the OAuthSetting name in the OAuthPrompt in the code.</li>
</ul>
So for every call that is made to the API, the Azure Bot Service First Checks if the token is valid, if it is not valid then the Bot Service forces the user to provide the log in credentials to reestablish a secure connection to the API.
<h1>Design Principle</h1>
<p>In this article, we are not going to impart intelligence to our bot. Our bot will do only function of querying and displaying the FitBit data to the user. Our use case is simple, hence our design should also be simple. One point that we need to consider is that since the bot relies on conversation to gather data, it is a real possibility that the user might try to lead the bot astray by asking random questions that are out of the scope of the bot. If that happens then the bot will start to behave stupidly and will not be able to resolve the queries of the user. This results into a poor user experience, which will in inadvertently led to the user getting fed up with the bot and they will not come back to use the bot services. So the principle for our design is simple “<strong>We will greet the user and tell them what the bot can do. If the user tries to request any other option we will politely redirect them to what we can do</strong>”
</p>
<h1>Implementation</h1>
We will discuss the implementation of the bot using following two categories
<ul>
    <li>Development</li>
    <li>Deployment</li>
</ul>
<h2>Development</h2>
<h3>Creating FitBit Application</h3>
FitBit application can be created using the FitBit Development portal at&nbsp;<a href="https://dev.fitbit.com/apps/new" target="_blank" rel="noopener">Create a new FitBit application</a>. Fill out the details as shown in the sample below.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/4667.create_2D00_a_2D00_fitbit_2D00_application.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/4667.create_2D00_a_2D00_fitbit_2D00_application.jpg" style="border-width: 0px; border-style: solid;"></a></p>
<p>It is important to note that the CallBack URL needs to be <strong>"https://token.botframework.com/.auth/web/redirect"</strong>&nbsp;always for the Azure Bot Service to pickup the token. Once we click on Register, we will get the Client Id, App Id and the other details. Make a note of the Client ID and the Client Secret, we will need it later on during our deployment time.
</p>
<h3>FitBit Web API</h3>
Fit Bit Web API&nbsp;documentation is available extensively at the FitBit dev portal at&nbsp;<a href="https://dev.fitbit.com/build/reference/web-api/" target="_blank" rel="noopener">FitBit Web Api</a>&nbsp;In this article we will set up two functionalities in the bot viz. Get <strong>My Profile</strong> and <strong>My Badges&nbsp;</strong>
<h3>Bot</h3>
We will explore the Bot Code in this section.
Create the Bot project using the EchoBot template in visual Studio 2017. Once the project is finished the solution will look something like below.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7875.botproject.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/7875.botproject.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<p>Let us explore each class is detail.
</p>
<h4>Constant.cs</h4>
Constant values are stored in a separate constants class. The important entries in the constants class that we will use again and again are
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/1663.dialognames.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/1663.dialognames.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/0435.fitbitendpoints.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/0435.fitbitendpoints.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<p><br>
</p>
<h4>GenericHelper.cs</h4>
This class contains all the generic methods that can be reused across the code.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/4011.generichelper1.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/4011.generichelper1.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h4>FitBitApiHelper.cs</h4>
This is a wrapper class that is used to call the FitBit Web API. This class has a constructor which accepts the token extracted from the Azure Bot Service, This token is then added as Authorization header in each request made to the FitBit Web API. The class looks like following.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/5611.fitbtapihelper1.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/5611.fitbtapihelper1.jpg" style="border-width: 0px; border-style: solid;"></a></p>
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7851.fitbtapihelper2.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/7851.fitbtapihelper2.jpg" style="border-width: 0px; border-style: solid;"></a></p>
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/1007.fitbtapihelper3.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/1007.fitbtapihelper3.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<p><br>
</p>
<h4>DialogHelpers.cs</h4>
This class contains all the methods used during the management of the conversation of the bot. It contains methods to create the Rich Cards like the welcome card, the HelpCard, the Adaptive Cards, OAuth Prompt etc.
<h5>Welcome Card</h5>
Following code snippet creates a welcome user hero card which the bot will send to the user to welcome them. It will contain the links for Login, MyProfile, MyBadges, Help and Log Out. If the user is not authenticated at a particular point, the bot will redirect the user to the OAuth prompt to login using the FitBit credentials.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/2821.welcomecard.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/2821.welcomecard.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>Functions Card</h5>
This card details all the function that the bot can perform.We will send this card as attachment after each successful task so that user can perform other task.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3666.functionscard.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/3666.functionscard.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>Helper Card</h5>
This card list all the operations and the log out option for the user.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7384.helpercard.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/7384.helpercard.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>Error Card</h5>
We will send this card whenever the bot encounters any unhandled exception. It will request the user to close the chat and try again.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3683.errorcard.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/3683.errorcard.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>UserProfileAdaptiveCard</h5>
This card is sent as an adaptive card to display the user profile. This method modifies the Adaptive card generated for the user profile. It looks like below
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3005.createuseradaptivecard.jpg"><img alt="" src="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3005.createuseradaptivecard.jpg" style="border-width: 0px; border-style: solid;" "width="200'" "height="500'"></a>
</p>
<h5>User Badges Adaptive Card</h5>
This is an adaptive card which is used to display the badges earned by the user. Following is the method used to parse the User Badge Details received from FitBit to the adaptive card.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/0027.createuserbadge2.jpg"><img alt="" src="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/0027.createuserbadge2.jpg" "width="500'" "height="500'"></a>
</p>
<h5>OAuthPrompt</h5>
This prompt is used to send out the OAuth card for the User to LogIn to the FitBit Portal so that the Bot can query the data from the FitBit API&nbsp; The Card will be presented each time the Azure Bot Service determines that is does not have a valid token to call the FitBit web API. The <strong>connectionName&nbsp;</strong> is the name of the OAuth connection that we will create when we deploy the bot. We can configure the name now and we will use the same name while deploying the bot.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/5127.oauthprompt.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/5127.oauthprompt.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>Send Welcome Message</h5>
The bot will use this task to send the welcome message to the user when they are added to the conversation. This creates and sends activity which has the welcome hero card attached to it.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/8611.sendwelcomemessage.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/8611.sendwelcomemessage.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>Send Error Message</h5>
This task will be used by the bot to send an activity which contains the error hero card attached to it.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3750.senderrormessage.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/3750.senderrormessage.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h4>FitBitAssistantBotAccessors.cs</h4>
This class defines the properties that we want to save in the store of the bot so that they can be utilized across the calls in a particular session. This class is inserted as a singleton during the startup of the bot. The class is as follows
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3276.fitbotbotaccessors.jpg"><img alt="" src="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3276.fitbotbotaccessors.jpg" style="border-width: 0px; border-style: solid;" "width="200'" "height="250'"></a>
</p>
<p>This is one of the most important classes of the entire bot. This class implements the IBot interface and determines the action that should be taken based upon certain inputs. The constructor for this class initialize the necessary dialogs and&nbsp; then the OnTurnAsync method processes the activity received/sent on each of the turn. Let us take a look at this class in-depth now.
</p>
<h5>FitBitAssistantBot.cs</h5>
<p>This is one of the most important classes of the entire bot. This class implements the IBot interface and determines the action that should be taken based upon certain inputs. The constructor for this class initialize the necessary dialogs and&nbsp; then the OnTurnAsync method processes the activity received/sent on each of the turn. Let us take a look at this class in-depth now.
</p>
<h5>Constructor</h5>
The constructor of the class accepts the Bot Accessor object which if fed to it at the startup.&nbsp; This accessor object contains the state of the User, Command and the conversation which determines what action needs to be taken in the OnTurnAsync method. The constructor also initialize the dialogset which <strong>must</strong> contain the names of all the dialogs that will be used in the process. If any dialog name is missing from the dialogset and we try perform any activity on the dialogset, in such case we will get an exception.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/1447.constructor.jpg"><span style="white-space: pre;">				</span><img alt="" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/1447.constructor.jpg" style="border-width: 0px; border-style: solid;"></a>
</p>
<h5>ProcessInputAsync</h5>
This method is used to process the input that the user sends to the bot. this method contains a switch case statement which will take different actions based upon the command that is received.
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7875.processinputasync.jpg"><img alt="" src="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7875.processinputasync.jpg" style="border-width: 0px; border-style: solid;" "width="200'" "height="500'"></a>
</p>
<p>If the user sends the logout command, the bot will get the BotFrameworkAdapter object from the particular turn context and then invoke the <strong>SignOutUserAsync&nbsp;</strong>method to sign out the user. This will also notify the Azure Bot Service to cancel the current OAuth token stored after granting the Consent to the FitBit web API. Once the user is sign out we send back a response activity requesting the user to close the chat session or to type in anything to log in again.
<br>
In case the user sends out the help command, then we send out a response activity with the help hero card that we created earlier as an attachment.
</p>
<p>In default case, we will create a new dialog where the user will first log in and then based upon the command will present them the options
</p>
<h5>WaterFall Steps</h5>
The default clause in the OnTurnAsync method will invoke a waterfall dialog which is defined as
<div class="reCodeBlock" style="border: 1px solid #7f9db9; overflow-y: auto;">
<div style="background-color: #ffffff;"><span style="margin-left: 0px !important;"><code style="color: #000000;">_dialogs.Add(</code><code style="color: #006699; font-weight: bold;">new</code><code style="color: #000000;">WaterfallDialog(Constants.RootDialogName, </code><code style="color: #006699; font-weight: bold;">new</code><code style="color: #000000;">WaterfallStep[] { PromptStepAsync, ProcessStepAsync }));</code></span></div>
</div>
<h6>PromptStepAsync</h6>
This method sets the context of the message and initiates the OAuth Prompt that we have seen before.
<p><br>
</p>
<h6>ProcessInputAsync</h6>
<p>This step checks if the token that we have after providing the consent to the FitBit web API&nbsp;is valid or not. If the Token is not valid, the user is presented with the OAuthPrompt which will prompt the user to login. If the token is valid, then we parse the command state to get the command that bot received and invoke the respective function from the FitBitApi Helper class that we created earlier. In case the command is not handled in the if else statement, the final else sends out the function card to user to inform them of what functions the bot can handle.
</p>
<h4>Startup.cs</h4>
<p><br>
</p>
<p><br>
</p>
<p><br>
</p>
<p><br>
</p>
<h6></h6>
<h6></h6>
<h6></h6>
<h6></h6>